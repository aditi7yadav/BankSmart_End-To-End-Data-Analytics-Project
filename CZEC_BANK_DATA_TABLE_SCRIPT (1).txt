CREATE DATABASE BANK;

USE BANK;
CREATE DATABASE BANK;

USE BANK;


CREATE OR REPLACE TABLE DISTRICT(
District_Code INT PRIMARY KEY	,
District_Name VARCHAR(100)	,
Region VARCHAR(100)	,
No_of_inhabitants	INT,
No_of_municipalities_with_inhabitants_less_499 INT,
No_of_municipalities_with_inhabitants_500_btw_1999	INT,
No_of_municipalities_with_inhabitants_2000_btw_9999	INT,
No_of_municipalities_with_inhabitants_less_10000 INT,	
No_of_cities	INT,
Ratio_of_urban_inhabitants	FLOAT,
Average_salary	INT,
No_of_entrepreneurs_per_1000_inhabitants INT,
No_committed_crime_2017	INT,
No_committed_crime_2018 INT
) ;



CREATE OR REPLACE TABLE ACCOUNT(
account_id INT PRIMARY KEY,
district_id	INT,
frequency	VARCHAR(40),
Date DATE ,
Account_Type VARCHAR(100) ,
Card_Assigned VARCHAR(20),
FOREIGN KEY (district_id) references DISTRICT(District_Code) 
);

CREATE OR REPLACE TABLE ORDER_LIST (
order_id	INT PRIMARY KEY,
account_id	INT,
bank_to	VARCHAR(45),
account_to	INT,
amount FLOAT,
FOREIGN KEY (account_id) references ACCOUNT(account_id)
);



CREATE OR REPLACE TABLE LOAN(
loan_id	INT ,
account_id	INT,
Date	DATE,
amount	INT,
duration	INT,
payments	INT,
status VARCHAR(35),
FOREIGN KEY (account_id) references ACCOUNT(account_id)
);



CREATE OR REPLACE TABLE TRANSACTIONS(
trans_id INT,	
account_id	INT,
Date	DATE,
Type	VARCHAR(30),
operation	VARCHAR(40),
amount	INT,
balance	FLOAT,
Purpose	VARCHAR(40),
bank	VARCHAR(45),
account_partner_id INT,
FOREIGN KEY (account_id) references ACCOUNT(account_id));


CREATE OR REPLACE TABLE CLIENT(
client_id	INT PRIMARY KEY,
Sex	CHAR(10),
Birth_date	DATE,
district_id INT,
FOREIGN KEY (district_id) references DISTRICT(District_Code) 
);


CREATE OR REPLACE TABLE DISPOSITION(
disp_id	INT PRIMARY KEY,
client_id INT,
account_id	INT,
type CHAR(15),
FOREIGN KEY (account_id) references ACCOUNT(account_id),
FOREIGN KEY (client_id) references CLIENT(client_id)
);


CREATE OR REPLACE TABLE CARD(
card_id	INT PRIMARY KEY,
disp_id	INT,
type CHAR(10)	,
issued DATE,
FOREIGN KEY (disp_id) references DISPOSITION(disp_id)
);

---------------------------------------------------------------------------------------------

CREATE OR REPLACE STORAGE integration s3_int
TYPE = EXTERNAL_STAGE
STORAGE_PROVIDER = S3
ENABLED = TRUE
STORAGE_AWS_ROLE_ARN ='arn:aws:iam::730335303881:role/bankrole'
STORAGE_ALLOWED_LOCATIONS =('s3://czechnationalbank/');

DESC integration s3_int;

CREATE OR REPLACE FILE FORMAT my_csv_format
  TYPE = 'CSV'                        -- Specifies the file type as CSV
  FIELD_DELIMITER = ','               -- Character used to separate fields
  SKIP_HEADER = 1                     -- Skip the first row as a header
  FIELD_OPTIONALLY_ENCLOSED_BY = '"'  -- Fields optionally enclosed by double quotes
  TRIM_SPACE = TRUE                   -- Trim spaces around field values
  NULL_IF = ('NULL', '')              -- Treat 'NULL' or empty strings as NULL
  EMPTY_FIELD_AS_NULL = TRUE;         -- Treat empty fields as NULL

CREATE OR REPLACE STAGE BANK
URL ='s3://czechnationalbank'
--credentials=(aws_key_id='AKIAXQKR3H3PSG72XFMK'aws_secret_key='eKL6a6FjlQHic4s8Ne712Aelzg2ou4j6tNsVvFq5')
file_format = my_csv_format
storage_integration = s3_int;

LIST @BANK;

SHOW STAGES;

--CREATE SNOWPIPE THAT RECOGNISES CSV THAT ARE INGESTED FROM EXTERNAL STAGE AND COPIES THE DATA INTO EXISTING TABLE

--The AUTO_INGEST=true parameter specifies to read 
--- event notifications sent from an S3 bucket to an SQS queue when new data is ready to load.


CREATE OR REPLACE PIPE BANK_SNOWPIPE_DISTRICT AUTO_INGEST = TRUE AS
COPY INTO "BANK"."PUBLIC"."DISTRICT" --yourdatabase -- your schema ---your table
FROM '@BANK/District/' --s3 bucket subfolde4r name
FILE_FORMAT = my_csv_format;

CREATE OR REPLACE PIPE BANK_SNOWPIPE_ACCOUNT AUTO_INGEST = TRUE AS
COPY INTO "BANK"."PUBLIC"."ACCOUNT"
FROM '@BANK/Account/'
FILE_FORMAT = my_csv_format;

CREATE OR REPLACE PIPE BANK_SNOWPIPE_TXNS AUTO_INGEST = TRUE AS
COPY INTO "BANK"."PUBLIC"."TRANSACTIONS"
FROM '@BANK/Tranx/'
FILE_FORMAT = my_csv_format;

CREATE OR REPLACE PIPE BANK_SNOWPIPE_DISP AUTO_INGEST = TRUE AS
COPY INTO "BANK"."PUBLIC"."DISPOSITION"
FROM '@BANK/disp/'
FILE_FORMAT = my_csv_format;

CREATE OR REPLACE PIPE BANK_SNOWPIPE_CARD AUTO_INGEST = TRUE AS
COPY INTO "BANK"."PUBLIC"."CARD"
FROM '@BANK/Card/'
FILE_FORMAT = my_csv_format;

CREATE OR REPLACE PIPE BANK_SNOWPIPE_ORDER_LIST AUTO_INGEST = TRUE AS
COPY INTO "BANK"."PUBLIC"."ORDER_LIST"
FROM '@BANK/Order/'
FILE_FORMAT = my_csv_format;

CREATE OR REPLACE PIPE BANK_SNOWPIPE_LOAN AUTO_INGEST = TRUE AS
COPY INTO "BANK"."PUBLIC"."LOAN"
FROM '@BANK/Loan/'
FILE_FORMAT = my_csv_format;

CREATE OR REPLACE PIPE BANK_SNOWPIPE_CLIENT AUTO_INGEST = TRUE AS
COPY INTO "BANK"."PUBLIC"."CLIENT"
FROM '@BANK/Client/'
FILE_FORMAT = my_csv_format;

SHOW PIPES;

SELECT count(*) FROM DISTRICT;
SELECT count(*) FROM ACCOUNT;
SELECT count(*) FROM TRANSACTIONS;
SELECT count(*) FROM DISPOSITION;
SELECT count(*) FROM CARD;
SELECT count(*) FROM ORDER_LIST;
SELECT count(*) FROM LOAN;
SELECT count(*) FROM CLIENT;

ALTER PIPE BANK_SNOWPIPE_DISTRICT refresh;

ALTER PIPE BANK_SNOWPIPE_ACCOUNT refresh;

ALTER PIPE BANK_SNOWPIPE_TXNS refresh;

ALTER PIPE BANK_SNOWPIPE_DISP refresh;

ALTER PIPE BANK_SNOWPIPE_CARD refresh;

ALTER PIPE BANK_SNOWPIPE_ORDER_LIST refresh;

ALTER PIPE BANK_SNOWPIPE_LOAN refresh;

ALTER PIPE BANK_SNOWPIPE_CLIENT refresh;
-----------------------------------------------------------------------------------------------------------------------------------------------
SELECT * FROM DISTRICT;
SELECT * FROM ACCOUNT;
SELECT * FROM TRANSACTIONS;
SELECT * FROM DISPOSITION;
SELECT * FROM CARD;
SELECT * FROM ORDER_LIST;
SELECT * FROM LOAN;
SELECT * FROM CLIENT;


SELECT * FROM TRANSACTIONS WHERE BANK IS NULL AND YEAR(DATE)= '2016';

SELECT YEAR(DATE) AS TXN_YEAR, COUNT(*) AS TOT_TXN
FROM TRANSACTIONS
WHERE BANK IS NULL
GROUP BY 1
ORDER BY 1;


SELECT YEAR(DATE), COUNT(*) AS TOTAL
FROM TRANSACTIONS
GROUP BY 1
ORDER BY 2 DESC;

--CONVERT 2021 TXN_YEAR TO 2022
--2020 TO 2021
--2018 TO 2020
--2017 TO 2019
--2016 TO 2018

--Data transformation
-- updating one by one
UPDATE TRANSACTIONS
SET DATE=DATEADD(YEAR,1,DATE)
WHERE YEAR(DATE)='2016'


SELECT MIN(DATE),MAX(DATE) FROM TRANSACTIONS;

SELECT * FROM TRANSACTIONS WHERE BANK IS NULL AND YEAR(DATE) ='2022'

UPDATE TRANSACTIONS 
SET BANK ='SKY BANK'WHERE BANK IS NULL AND YEAR(DATE)='2022'


SELECT * FROM TRANSACTIONS WHERE BANK IS NULL AND YEAR(DATE) ='2021'

UPDATE TRANSACTIONS 
SET BANK ='DBS BANK'WHERE BANK IS NULL AND YEAR(DATE)='2021'

SELECT * FROM TRANSACTIONS WHERE BANK IS NULL AND YEAR(DATE) ='2020'


SELECT * FROM TRANSACTIONS WHERE BANK IS NULL AND YEAR(DATE) ='2019'
UPDATE TRANSACTIONS 
SET BANK ='NORTHERN BANK'WHERE BANK IS NULL AND YEAR(DATE)='2019'

SELECT * FROM TRANSACTIONS WHERE BANK IS NULL AND YEAR(DATE) ='2018'
UPDATE TRANSACTIONS 
SET BANK ='SOUTHERN BANK'WHERE BANK IS NULL AND YEAR(DATE)='2018'

SELECT * FROM TRANSACTIONS WHERE BANK IS NULL AND YEAR(DATE) ='2017'
UPDATE TRANSACTIONS 
SET BANK ='ABS BANK'WHERE BANK IS NULL AND YEAR(DATE)='2017'


SELECT * FROM CARD
SELECT DISTINCT YEAR(ISSUED) 
FROM CARD;

SELECT * FROM DISTRICT;

SELECT * FROM ACCOUNT;

SELECT * FROM DISPOSITION;

SELECT * FROM ORDER_LIST;

-----ADDING AGE COLUMN TO THE CLIENT TABLE
ALTER TABLE CLIENT
ADD COLUMN AGE INT;

UPDATE CLIENT
SET AGE = DATEDIFF('YEAR',BIRTH_DATE,'2022-12-19');

SELECT * FROM CLIENT;

--CONVERT czk to USD 